# CFB支付系统 - 自动化测试分析

> 分析日期: 2026-02-11
> 基于 BS-支付系统测试经验

---

## 🎯 系统概述

### 三个系统

| 系统 | URL | 角色 | 主要功能 |
|------|-----|------|----------|
| **管理后台** | test-admin.cfbaopay.com | 管理员 | 商户管理、通道配置、系统设置 |
| **代理系统** | test-agent.cfbaopay.com | 代理商 | 代理商户管理、订单查看、佣金 |
| **商户系统** | test-merch.cfbaopay.com | 商户 | 交易操作、提现、归集 |

---

## 📊 功能模块分析

### 一、商户管理

| 功能 | 所属系统 | 测试要点 |
|------|----------|----------|
| **开新商户** | admin | 商户注册、资质审核、创建账户 |
| **商户配置** | admin/merch | 密钥配置、限额设置 |
| **商户状态** | admin | 启用/禁用/冻结 |

### 二、通道管理

| 功能 | 所属系统 | 测试要点 |
|------|----------|----------|
| **配置通道** | admin | 添加/编辑支付通道（CNY、USDT等） |
| **绑定通道** | merch | 商户绑定可用通道 |
| **通道费率** | admin/merch | 费率设置、结算周期 |

### 三、交易功能

| 功能 | 币种 | 系统 | 说明 |
|------|------|------|------|
| **代收** | CNY | merch | 商户收款 |
| **代付** | USDT(TRC/BEP) | merch | 提现/转账 |
| **补单** | ALL | admin/merch | 补单处理 |
| **退款** | ALL | admin/merch | 退款处理 |
| **调额** | ALL | admin | 调整限额 |

### 四、特殊功能

| 功能 | 系统 | 说明 |
|------|------|------|
| **商户互转** | admin | 商户间资金转移 |
| **手动归集** | merch/admin | 资金归集到主账户 |
| **自动归集** | system | 自动定时归集 |
| **首页提现** | merch | 商户发起提现 |

### 五、支持的链

| 链类型 | 版本 | 用途 |
|--------|------|------|
| **TRC20** | v2-v6 | USDT TRON链 |
| **BEP20** | v2-v6 | USDT BSC链 |
| **ERC20** | v2-v6 | USDT ETH链 |
| **CNY** | - | 人民币法币 |

---

## 🔧 技术实现分析

### 1. 认证方式

| 类型 | 说明 | 测试方法 |
|------|------|----------|
| **Cookie** | 登录后Cookie | 浏览器登录+Cookie提取 |
| **Token** | JWT/API Token | 请求头携带 |
| **API Key** | 商户密钥 | 签名验证 |

### 2. 签名算法

| 算法 | 用途 | 位置 |
|------|------|------|
| **MD5** | 订单签名 | 请求参数 |
| **RSA** | API签名 | 请求签名 |
| **AES** | 敏感数据加密 | 回调数据 |

### 3. 链类型识别

```
CNY     → 法币通道
TRC20   → USDT TRON链 (T开头地址)
BEP20   → USDT BSC链 (0x开头地址)
ERC20   → USDT ETH链 (0x开头地址)
```

---

## 🧪 测试用例设计

### 优先级排序

| 优先级 | 功能 | 原因 |
|--------|------|------|
| **P0** | 开新商户 | 核心流程 |
| **P0** | 代收/代付 | 核心交易 |
| **P1** | 通道配置 | 系统基础 |
| **P1** | 补单/退款 | 异常处理 |
| **P2** | 调额/归集 | 辅助功能 |
| **P2** | 商户互转 | 资金安全 |

### P0级测试用例

#### 1. 开新商户流程

```python
def test_create_merchant():
    """
    测试用例: 创建新商户
    
    步骤:
    1. 登录管理员
    2. 进入商户管理
    3. 点击新增商户
    4. 填写商户信息
    5. 提交审核
    6. 审核通过
    7. 验证商户状态
    """
```

#### 2. 代收流程

```python
def test_collection():
    """
    测试用例: 代收交易
    
    步骤:
    1. 登录商户
    2. 创建代收订单
    3. 获取支付链接
    4. 模拟支付
    5. 查询订单状态
    6. 验证余额变化
    """
```

#### 3. 代付流程（TRC20）

```python
def test_payment_trc20():
    """
    测试用例: USDT-TRC20代付
    
    步骤:
    1. 登录商户
    2. 创建代付订单
    3. 填写收款地址(T开头)
    4. 确认金额
    5. 查询链上状态
    6. 验证完成
    """
```

---

## 📁 项目结构建议

```
cfb_payment_test/
├── config/
│   └── config.js              # 配置文件（敏感）
├── tests/
│   ├── test_merchant.py       # 商户管理测试
│   ├── test_collection.py     # 代收测试
│   ├── test_payment.py        # 代付测试
│   ├── test_refund.py        # 退款测试
│   ├── test_replenish.py     # 补单测试
│   └── test_transfer.py       # 转账测试
├── utils/
│   ├── auth.py                # 认证模块
│   ├── signature.py           # 签名模块
│   ├── browser.py             # 浏览器控制
│   └── api.py                 # API封装
├── reports/
│   └── test_report.html       # 测试报告
├── docs/
│   └── API.md                 # 接口文档
└── README.md
```

---

## 🔧 技术选型

| 场景 | 推荐工具 | 原因 |
|------|----------|------|
| **UI自动化** | Playwright | 跨浏览器、稳定 |
| **API测试** | Requests | 简单高效 |
| **签名** | hashlib/Crypto | Python原生支持 |
| **报告** | Allure | 美观、可追踪 |

---

## ⚠️ 风险点

| 风险 | 影响 | 应对 |
|------|------|------|
| **资金安全** | 极高 | 测试环境+小额测试 |
| **环境隔离** | 高 | 使用test环境 |
| **数据清理** | 中 | 独立测试数据 |
| **回调测试** | 中 | 模拟回调服务 |

---

## 📋 第一阶段任务

### Day 1: 环境搭建

- [ ] 分析三个系统页面结构
- [ ] 抓取登录流程
- [ ] 配置浏览器环境
- [ ] 实现登录Cookie管理

### Day 2: 核心功能

- [ ] 开新商户自动化
- [ ] 代收流程实现
- [ ] 代付流程实现（TRC20）

### Day 3: 扩展功能

- [ ] BEP20/ERC20代付
- [ ] 补单/退款功能
- [ ] 通道配置自动化

---

## 🎯 关键成功指标

| 指标 | 目标 | 测量方法 |
|------|------|----------|
| 自动化覆盖率 | 80% | 手动用例/自动用例 |
| 执行稳定性 | 95% | 成功次数/总执行 |
| 执行时间 | <30min | 单次完整回归 |
| 缺陷发现率 | >60% | 自动化发现/总发现 |

---

## 📚 参考资源

| 资源 | 链接 |
|------|------|
| BS支付测试项目 | `/Users/qin/.openclaw/workspace/bs_payment_test/` |
| 支付测试文档 | `/Users/qin/.openclaw/workspace/bs_payment_test/README.md` |
| API签名算法 | `bs_payment_test/utils/signature.py` |

---

## 💡 建议

1. **先API后UI**
   - 核心交易用API测试
   - 复杂流程用UI辅助

2. **先核心后辅助**
   - 代收代付优先
   - 归集合并后续

3. **先测试后生产**
   - 全部在test环境验证
   - 生产环境仅验证关键流程

4. **数据驱动**
   - 测试数据配置化
   - 场景参数化

---

*分析时间: 2026-02-11*
*基于 BS-支付系统测试经验*
